<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visualizar Currículos - Mercado Arapiraca</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="auth.js"></script>
  <style>
    :root {
      --bg-light: #f8fafc; --text-light: #1e293b;
      --accent-light: #059669; --accent-light-hover: #047857;
      --secondary-light: #10b981; --secondary-light-hover: #059669;
      --focus-ring-light: #dc2626; --error-light: #dc2626; --success-light: #059669;
      --border-light: #e2e8f0; --shadow-light: rgba(0,0,0,.05);
      --input-bg-light: #fff; --input-text-light: #475569;
      --card-bg-light: #ffffff; --legend-text-light: #64748b;
      --step-bg-light: #f8fafc;
      --header-bg-light: linear-gradient(135deg, #059669 0%, #10b981 100%);

      --bg-dark: #0f172a; --text-dark: #f1f5f9;
      --accent-dark: #10b981; --accent-dark-hover: #059669;
      --secondary-dark: #34d399; --secondary-dark-hover: #10b981;
      --focus-ring-dark: #ef4444; --error-dark: #f87171; --success-dark: #34d399;
      --border-dark: #334155; --shadow-dark: rgba(255,255,255,.05);
      --input-bg-dark: #1e293b; --input-text-dark: #cbd5e1; 
      --card-bg-dark: #1e293b; --legend-text-dark: #94a3b8;
      --step-bg-dark: #1e293b;
      --header-bg-dark: linear-gradient(135deg, #047857 0%, #059669 100%);

      --bg: var(--bg-light); --text: var(--text-light); --accent: var(--accent-light);
      --accent-hover: var(--accent-light-hover); --focus-ring: var(--focus-ring-light);
      --error-color: var(--error-light); --success-color: var(--success-light);
      --border: var(--border-light); --shadow: var(--shadow-light);
      --input-bg: var(--input-bg-light); --input-text: var(--input-text-light);
      --card-bg: var(--card-bg-light); --legend-text: var(--legend-text-light);
      --step-bg: var(--step-bg-light);
      --header-bg: var(--header-bg-light);
      --transition-speed: .3s;
      --border-radius: 16px;
      --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      --header-height: 180px;
    }
    
    [data-theme='dark'] {
      --bg: var(--bg-dark); --text: var(--text-dark); --accent: var(--accent-dark);
      --accent-hover: var(--accent-dark-hover); --focus-ring: var(--focus-ring-dark);
      --error-color: var(--error-dark); --success-color: var(--success-dark);
      --border: var(--border-dark); --shadow: var(--shadow-dark);
      --input-bg: var(--input-bg-dark); --input-text: var(--input-text-dark);
      --card-bg: var(--card-bg-dark); --legend-text: var(--legend-text-dark);
      --step-bg: var(--step-bg-dark);
      --header-bg: var(--header-bg-dark);
      --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; transition: background-color var(--transition-speed), color var(--transition-speed); min-height: 100vh; }
    .app-container { width: 100%; max-width: 1400px; margin: 0 auto; position: relative; }
    
    /* HEADER */
    .header { background: var(--header-bg); color: white; padding: 2rem; border-radius: 0 0 var(--border-radius) var(--border-radius); text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
    .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); opacity: 0.3; }
    .header-content { position: relative; z-index: 1; }
    h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; }
    .header-subtitle { font-size: 1rem; opacity: 0.9; margin-bottom: 1.5rem; font-weight: 400; }
    
    /* USER MENU */
    .header-actions { position: absolute; top: 1.5rem; right: 1.5rem; display: flex; align-items: center; gap: 1rem; z-index: 10; }
    .theme-toggle { background: rgba(255, 255, 255, 0.2); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; transition: all 0.3s ease; }
    .theme-toggle:hover { background: rgba(255, 255, 255, 0.3); transform: rotate(30deg); }
    .user-menu { position: relative; }
    .user-menu-button { background: rgba(255, 255, 255, 0.2); border: none; height: 40px; border-radius: 20px; color: white; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; padding: 0 15px 0 10px; gap: 10px; }
    .user-menu-button:hover { background: rgba(255, 255, 255, 0.3); }
    .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
    .user-menu-dropdown { display: none; position: absolute; top: 50px; right: 0; background: var(--card-bg); border-radius: 8px; box-shadow: var(--card-shadow); list-style: none; padding: 0.5rem 0; min-width: 180px; z-index: 20; }
    .user-menu-dropdown.show { display: block; }
    .user-menu-dropdown li a { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem 1.2rem; color: var(--text); text-decoration: none; font-size: 0.9rem; }
    .user-menu-dropdown li a:hover { background: color-mix(in srgb, var(--accent) 10%, transparent); }
    .user-menu-dropdown li a i { width: 16px; text-align: center; }

    /* CONTENT */
    .main-content { padding: 1.5rem; }
    .content-card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--card-shadow); overflow: hidden; margin-bottom: 1.5rem; }
    
    /* FILTERS */
    .filters-panel { padding: 1.5rem; border-bottom: 1px solid var(--border); }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .filter-group { display: flex; flex-direction: column; }
    .filter-group label { margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 600; color: var(--text); }
    .filter-select, .filter-input { padding: 0.8rem 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--input-text); font-size: 0.9rem; transition: all var(--transition-speed); outline: none; }
    .filter-select:focus, .filter-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent); }
    .filter-actions { display: flex; gap: 1rem; justify-content: flex-end; align-items: center; margin-top: 1rem; }
    .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all var(--transition-speed); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover { background: color-mix(in srgb, var(--border) 80%, black); }
    
    /* TABLE */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: linear-gradient(90deg, var(--accent), var(--accent-hover)); color: white; }
    th, td { padding: 1rem 1.2rem; text-align: left; border-bottom: 1px solid var(--border); }
    tbody tr:hover { background: color-mix(in srgb, var(--accent) 5%, transparent); }
    .action-btn { padding: 0.5rem 0.8rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all var(--transition-speed); margin: 0 0.2rem; }
    .action-btn.view { background: var(--accent); color: white; }
    .action-btn.download { background: var(--secondary-light); color: white; }
    .action-btn.distance { background: #8b5cf6; color: white; }
    .action-btn.delete { background: var(--error-color); color: white; }
    .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .badge-success { background: color-mix(in srgb, var(--success-color) 15%, transparent); color: var(--success-color); }
    .badge-warning { background: color-mix(in srgb, #f97316 15%, transparent); color: #f97316; }
    
    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: var(--card-shadow); position: relative; animation: fadeInUp .3s; }
    .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--legend-text); }
    .modal-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .modal-header h2 { color: var(--text); font-size: 1.5rem; }
    
    /* TOAST */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: slideInRight 0.4s ease-out; display: flex; align-items: center; gap: 10px; }
    .toast.success { background-color: var(--success-color); }
    .toast.error { background-color: var(--error-color); }
    
    /* ANIMATIONS */
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      .header-actions { right: 1rem; }
      .user-menu-button span { display: none; }
      .filters-grid { grid-template-columns: 1fr; }
      .filter-actions { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body data-theme="light">
  <div id="toast-container"></div>

  <div class="app-container">
    <div class="header">
      <div class="header-actions">
        <div class="user-menu">
          <button class="user-menu-button" id="userMenuButton">
            <div class="user-avatar" id="userAvatar">?</div>
            <span id="userName">Carregando...</span>
            <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
          </button>
          <ul class="user-menu-dropdown" id="userMenuDropdown">
            <li><a href="#" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Sair (Logout)</a></li>
          </ul>
        </div>
        <button class="theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
      </div>
      
      <div class="header-content">
        <h1>Visualizar Currículos</h1>
        <p class="header-subtitle">Gerencie e visualize todas as candidaturas recebidas</p>
      </div>
    </div>

    <div class="main-content">
      <div class="content-card">
        <div class="filters-panel">
          <div class="filters-grid">
            <div class="filter-group">
              <label for="filter-vaga">Vaga</label>
              <select id="filter-vaga" class="filter-select">
                <option value="todas">Todas as vagas</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter-cidade">Cidade</label>
              <select id="filter-cidade" class="filter-select">
                <option value="todas">Todas as cidades</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter-transporte">Transporte</label>
              <select id="filter-transporte" class="filter-select">
                <option value="todos">Todos</option>
                <option value="Sim">Com transporte</option>
                <option value="Não">Sem transporte</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter-status">Status</label>
              <select id="filter-status" class="filter-select">
                <option value="todos">Todos os status</option>
                <option value="Novo">Novo</option>
                <option value="Selecionado">Selecionado</option>
                <option value="Não Atendeu a Ligação">Não Atendeu</option>
                <option value="Desistiu">Desistiu</option>
                <option value="Já trabalhou Aqui">Já trabalhou</option>
                <option value="Passou na Entrevista">Passou Entrevista</option>
                <option value="Já está trabalhando">Já trabalhando</option>
                <option value="Contratado">Contratado</option>
              </select>
            </div>
          </div>
          <div class="filter-actions">
            <div class="filter-group" style="flex: 1;">
              <label for="filter-search">Buscar (Nome, CPF, Email ou Telefone)</label>
              <input type="text" id="filter-search" class="filter-input" placeholder="Digite para buscar...">
            </div>
            <button class="btn btn-primary" id="aplicar-filtros">
              <i class="fas fa-filter"></i> Aplicar
            </button>
            <button class="btn btn-secondary" id="limpar-filtros">
              <i class="fas fa-eraser"></i> Limpar
            </button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Vaga</th>
                <th>Cidade</th>
                <th>Bairro</th>
                <th>Transporte</th>
                <th>Status</th>
                <th>Data</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="corpo-tabela">
              <tr>
                <td colspan="8" style="text-align: center;">Carregando currículos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALHES CANDIDATO -->
  <div id="candidato-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <div class="modal-header">
        <h2>Detalhes do Candidato</h2>
      </div>
      <div id="candidato-info"></div>
    </div>
  </div>

  <!-- MODAL DISTÂNCIA -->
  <div id="distancia-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <button class="modal-close">&times;</button>
      <div class="modal-header">
        <h2><i class="fas fa-route"></i> Calculadora de Distância</h2>
      </div>
      <div id="distancia-content"></div>
    </div>
  </div>

  <script>
    // =================================================================================
    // CONFIGURAÇÕES E AUTENTICAÇÃO
    // =================================================================================
    const API_BASE = "https://formulariobk.onrender.com";
    const LOGIN_PAGE_URL = 'index.html';
    
    // Estado da aplicação
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentFilters = {};

    // Elementos da DOM
    const themeToggle = document.getElementById('themeToggle');
    const userMenuButton = document.getElementById('userMenuButton');
    const userMenuDropdown = document.getElementById('userMenuDropdown');
    const logoutButton = document.getElementById('logoutButton');
    const candidatoModal = document.getElementById('candidato-modal');
    const distanciaModal = document.getElementById('distancia-modal');
    const corpoTabela = document.getElementById('corpo-tabela');
    const aplicarFiltrosBtn = document.getElementById('aplicar-filtros');
    const limparFiltrosBtn = document.getElementById('limpar-filtros');
    const filterVaga = document.getElementById('filter-vaga');
    const filterCidade = document.getElementById('filter-cidade');
    const filterTransporte = document.getElementById('filter-transporte');
    const filterStatus = document.getElementById('filter-status');
    const filterSearch = document.getElementById('filter-search');

    // =================================================================================
    // FUNÇÕES DE UI
    // =================================================================================

    // Mostra notificações (toasts)
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i> ${message}`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut .5s forwards';
            toast.addEventListener('animationend', () => toast.remove());
        }, 4000);
    }

    // Abrir modal
    function openModal(modalElement) {
        modalElement.style.display = 'flex';
    }

    // Fechar modal
    function closeModal(modalElement) {
        modalElement.style.display = 'none';
    }

    // Configurar menu do usuário
    function setupUserMenu() {
        const userName = localStorage.getItem('userName') || 'Admin';
        const userAvatar = document.getElementById('userAvatar');
        document.getElementById('userName').textContent = userName;
        userAvatar.textContent = userName.charAt(0).toUpperCase();

        userMenuButton.addEventListener('click', () => {
            userMenuDropdown.classList.toggle('show');
        });

        logoutButton.addEventListener('click', async (e) => {
            e.preventDefault();
            await authManager.logout();
        });

        // Fecha o dropdown se clicar fora
        window.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                userMenuDropdown.classList.remove('show');
            }
        });
    }

    // =================================================================================
    // FUNÇÕES DE API
    // =================================================================================
    async function apiCall(endpoint, options = {}) {
        // Verificar autenticação antes de cada chamada
        if (!authManager.isAuthenticated()) {
            showToast('Sessão expirada. Faça login novamente.', 'error');
            setTimeout(() => authManager.redirectToLogin(), 1500);
            throw new Error('Não autenticado');
        }

        try {
            const token = await authManager.getAccessToken();
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                showToast('Sessão expirada. Faça login novamente.', 'error');
                await authManager.logout();
                return;
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Erro ${response.status}`);
            }

            return response.json();
        } catch (error) {
            console.error('Erro na chamada da API:', error);
            if (error.message !== 'Não autenticado') {
                showToast('Erro na API: ' + error.message, 'error');
            }
            throw error;
        }
    }

    // =================================================================================
    // FUNÇÕES DE FORMATAÇÃO
    // =================================================================================
    function formatarData(dataString) {
        if (!dataString) return 'N/A';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function formatarTelefone(telefone) {
        if (!telefone) return 'N/A';
        const cleaned = ('' + telefone).replace(/\D/g, '');
        const match = cleaned.match(/^(\d{2})(\d{5})(\d{4})$/);
        if (match) {
            return `(${match[1]}) ${match[2]}-${match[3]}`;
        }
        return telefone;
    }

    // =================================================================================
    // FUNÇÕES DE CURRÍCULOS
    // =================================================================================
    async function carregarCurriculos() {
        try {
            corpoTabela.innerHTML = '<tr><td colspan="8" style="text-align: center;">Carregando currículos...</td></tr>';
            
            const params = new URLSearchParams({
                page: currentPage,
                limit: itemsPerPage,
                ...currentFilters
            });

            if (currentFilters.search) {
                params.append('search', currentFilters.search);
            }

            const data = await apiCall(`/api/admin/candidaturas?${params.toString()}`);
            
            if (data) {
                displayCurriculos(data.candidaturas);
            }
            
        } catch (error) {
            corpoTabela.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--error-color);">Erro ao carregar currículos.</td></tr>';
        }
    }

    function displayCurriculos(curriculos) {
        corpoTabela.innerHTML = '';

        if (!curriculos || curriculos.length === 0) {
            corpoTabela.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhuma candidatura encontrada com os filtros aplicados.</td></tr>';
            return;
        }

        const fragment = document.createDocumentFragment();

        curriculos.forEach(curriculo => {
            const tr = document.createElement('tr');
            const statusBadge = curriculo.transporte === 'Sim' ? 'badge-success' : 'badge-warning';
            const statusColor = getStatusColor(curriculo.status);
            
            tr.innerHTML = `
                <td><strong>${curriculo.nome}</strong></td>
                <td>${curriculo.vaga}</td>
                <td>${curriculo.cidade}</td>
                <td>${curriculo.bairro}</td>
                <td><span class="badge ${statusBadge}">${curriculo.transporte}</span></td>
                <td><span class="badge" style="background: color-mix(in srgb, ${statusColor} 15%, transparent); color: ${statusColor};">${curriculo.status}</span></td>
                <td>${formatarData(curriculo.enviado_em)}</td>
                <td>
                    <button class="action-btn view" title="Ver detalhes" data-id="${curriculo.id}"><i class="fas fa-eye"></i></button>
                    <button class="action-btn download" title="Baixar currículo" data-id="${curriculo.id}"><i class="fas fa-download"></i></button>
                    <button class="action-btn distance" title="Calcular distância" data-id="${curriculo.id}"><i class="fas fa-route"></i></button>
                    <button class="action-btn delete" title="Excluir candidatura" data-id="${curriculo.id}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            
            tr.querySelector('.view').addEventListener('click', () => visualizarCandidato(curriculo.id));
            tr.querySelector('.download').addEventListener('click', () => baixarCurriculo(curriculo.id));
            tr.querySelector('.distance').addEventListener('click', () => calcularDistanciaCandidato(curriculo.id));
            tr.querySelector('.delete').addEventListener('click', () => excluirCandidatura(curriculo.id));
            
            fragment.appendChild(tr);
        });

        corpoTabela.appendChild(fragment);
    }

    function getStatusColor(status) {
        const colors = {
            'Novo': '#3b82f6',
            'Selecionado': '#8b5cf6',
            'Não Atendeu a Ligação': '#ef4444',
            'Desistiu': '#f97316',
            'Já trabalhou Aqui': '#6b7280',
            'Passou na Entrevista': '#10b981',
            'Já está trabalhando': '#059669',
            'Contratado': '#047857'
        };
        return colors[status] || '#6b7280';
    }

    async function visualizarCandidato(id) {
        try {
            const infoDiv = document.getElementById('candidato-info');
            infoDiv.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Carregando detalhes...</p>';
            openModal(candidatoModal);

            const candidato = await apiCall(`/api/admin/candidaturas/${id}`);
            
            if (candidato) {
                infoDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 2rem; font-size: 0.95rem;">
                        <p><strong>Vaga:</strong> ${candidato.vaga}</p>
                        <p><strong>Nome:</strong> ${candidato.nome}</p>
                        <p><strong>Email:</strong> ${candidato.email}</p>
                        <p><strong>Telefone:</strong> ${formatarTelefone(candidato.telefone)}</p>
                        <p><strong>CPF:</strong> ${candidato.cpf}</p>
                        <p><strong>Data Nasc.:</strong> ${formatarData(candidato.data_nascimento)}</p>
                        <p><strong>Cidade:</strong> ${candidato.cidade}</p>
                        <p><strong>Bairro:</strong> ${candidato.bairro}</p>
                        <p><strong>Rua:</strong> ${candidato.rua}</p>
                        <p><strong>Número:</strong> ${candidato.numero}</p>
                        <p><strong>Transporte Próprio:</strong> <span class="badge ${candidato.transporte === 'Sim' ? 'badge-success' : 'badge-warning'}">${candidato.transporte}</span></p>
                        <p><strong>Status:</strong> <span class="badge" style="background: color-mix(in srgb, ${getStatusColor(candidato.status)} 15%, transparent); color: ${getStatusColor(candidato.status)};">${candidato.status}</span></p>
                        <p><strong>Enviado em:</strong> ${formatarData(candidato.enviado_em)}</p>
                    </div>
                    <h3 style="margin-top: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Informações Adicionais</h3>
                    <p style="white-space: pre-wrap;">${candidato.informacoes_adicionais || 'Nenhuma informação adicional fornecida.'}</p>
                    <div style="text-align: right; margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="baixarCurriculo(${candidato.id})"><i class="fas fa-download"></i> Baixar Currículo</button>
                        <button class="btn btn-secondary" onclick="calcularDistanciaCandidato(${candidato.id})"><i class="fas fa-route"></i> Calcular Distância</button>
                        <button class="btn btn-secondary" onclick="closeModal(candidatoModal)">Fechar</button>
                    </div>
                `;
            }

        } catch (error) {
            const infoDiv = document.getElementById('candidato-info');
            infoDiv.innerHTML = '<p style="text-align: center; color: var(--error-color);">Não foi possível carregar os detalhes do candidato.</p>';
        }
    }

    async function baixarCurriculo(id) {
        try {
            const result = await apiCall(`/api/admin/curriculo/${id}`);
            if (result && result.url) {
                // Criar link temporário para download
                const link = document.createElement('a');
                link.href = result.url;
                link.download = result.nome_arquivo || 'curriculo.pdf';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('Currículo baixado com sucesso!', 'success');
            }
        } catch (error) {
            showToast('Erro ao baixar currículo.', 'error');
        }
    }

    async function excluirCandidatura(id) {
        if (!confirm('Tem certeza que deseja excluir esta candidatura? Esta ação é irreversível.')) {
            return;
        }

        try {
            await apiCall(`/api/admin/candidaturas/${id}`, { method: 'DELETE' });
            showToast('Candidatura excluída com sucesso!', 'success');
            carregarCurriculos();
        } catch (error) {
            showToast('Falha ao excluir candidatura.', 'error');
        }
    }

    async function calcularDistanciaCandidato(id) {
        const distanciaContent = document.getElementById('distancia-content');
        distanciaContent.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Calculando distância...</p>';
        closeModal(candidatoModal);
        openModal(distanciaModal);

        try {
            // Primeiro buscar informações do candidato
            const candidato = await apiCall(`/api/admin/candidaturas/${id}`);
            
            if (!candidato) {
                throw new Error('Candidato não encontrado');
            }

            // Montar endereço completo do candidato
            const enderecoCandidato = `${candidato.rua}, ${candidato.numero}, ${candidato.bairro}, ${candidato.cidade}`;

            // Chamar API para calcular distância
            const result = await apiCall('/api/admin/calcular-distancia', {
                method: 'POST',
                body: JSON.stringify({
                    enderecoCandidato: enderecoCandidato,
                    enderecoTrabalho: 'Km 91, AL-220, 948 - Sen. Arnon de Melo, Arapiraca - AL, 57315-745'
                })
            });
            
            if (result) {
                distanciaContent.innerHTML = `
                    <h3 style="color: var(--accent); margin-bottom: 1rem;">Resultado do Cálculo</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; background: color-mix(in srgb, var(--accent) 5%, transparent); padding: 1.5rem; border-radius: 8px;">
                        <p><strong>Candidato:</strong> ${candidato.nome}</p>
                        <p><strong>Endereço:</strong> ${enderecoCandidato}</p>
                        <p><strong>Destino (Empresa):</strong> ${result.endereco_empresa || 'Mercado Arapiraca'}</p>
                        <p><strong>Status:</strong> <span class="badge badge-success">${result.status || 'OK'}</span></p>
                    </div>
                    <h3 style="margin-top: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Detalhes da Rota</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <p><strong>Distância:</strong> <span style="font-size: 1.2rem; font-weight: 600; color: var(--accent);">${result.distancia}</span></p>
                        <p><strong>Tempo Estimado:</strong> <span style="font-size: 1.2rem; font-weight: 600; color: var(--accent);">${result.duracao}</span></p>
                    </div>
                    ${result.observacao ? `<p style="margin-top: 1rem; padding: 1rem; background: color-mix(in srgb, var(--accent) 10%, transparent); border-radius: 8px; font-size: 0.9rem;"><strong>Observação:</strong> ${result.observacao}</p>` : ''}
                    <div style="text-align: right; margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="closeModal(distanciaModal)">Fechar</button>
                    </div>
                `;
            }

        } catch (error) {
            distanciaContent.innerHTML = `<p style="text-align: center; color: var(--error-color);">Falha ao calcular distância: ${error.message}</p>`;
        }
    }

    // =================================================================================
    // FUNÇÕES DE FILTROS
    // =================================================================================
    async function popularFiltros() {
        try {
            // Carregar vagas
            const vagas = await apiCall('/api/admin/vagas');
            if (vagas) {
                filterVaga.innerHTML = '<option value="todas">Todas as vagas</option>';
                vagas.forEach(vaga => {
                    const option = document.createElement('option');
                    option.value = vaga.nome;
                    option.textContent = vaga.nome;
                    filterVaga.appendChild(option);
                });
            }

            // Carregar cidades
            const cidades = await apiCall('/api/admin/filtros');
            if (cidades && cidades.cidades) {
                filterCidade.innerHTML = '<option value="todas">Todas as cidades</option>';
                cidades.cidades.forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade;
                    option.textContent = cidade;
                    filterCidade.appendChild(option);
                });
            }

        } catch (error) {
            console.error('Erro ao popular filtros:', error);
        }
    }

    // =================================================================================
    // INICIALIZAÇÃO E EVENT LISTENERS
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Aplicar tema salvo
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

        // Configurar elementos de UI
        setupUserMenu();
        
        // Carregar dados iniciais
        popularFiltros();
        carregarCurriculos();

        // Verificar autenticação
        if (!authManager.isAuthenticated()) {
            console.log('Usuário não autenticado, redirecionando para login...');
            authManager.redirectToLogin();
        }
    });

    // Eventos de Filtros
    aplicarFiltrosBtn.addEventListener('click', () => {
        currentFilters = {
            vaga: filterVaga.value === 'todas' ? undefined : filterVaga.value,
            cidade: filterCidade.value === 'todas' ? undefined : filterCidade.value,
            transporte: filterTransporte.value === 'todos' ? undefined : filterTransporte.value,
            status: filterStatus.value === 'todos' ? undefined : filterStatus.value,
            search: filterSearch.value.trim() || undefined
        };
        currentPage = 1;
        carregarCurriculos();
    });

    limparFiltrosBtn.addEventListener('click', () => {
        filterVaga.value = 'todas';
        filterCidade.value = 'todas';
        filterTransporte.value = 'todos';
        filterStatus.value = 'todos';
        filterSearch.value = '';
        currentFilters = {};
        currentPage = 1;
        carregarCurriculos();
    });

    // Evento de Tema
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    });

    // Eventos de Modal
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
            closeModal(e.target.closest('.modal'));
        });
    });

    // Fechar modais ao clicar fora
    window.addEventListener('click', (event) => {
        if (event.target === candidatoModal) closeModal(candidatoModal);
        if (event.target === distanciaModal) closeModal(distanciaModal);
    });

    // Permitir busca com Enter
    filterSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            aplicarFiltrosBtn.click();
        }
    });
  </script>
</body>
</html>
